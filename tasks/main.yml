---
# tasks file for app-matlab

- name: Resolve platform specific variables
  include_vars: "{{ item }}"
  with_first_found:
    - files:
        - '{{ ansible_os_family }}.yml'
        - 'default.yml'
      paths:
        - '{{ role_path }}/vars'

- name: Check if MATLAB install image already exists
  stat:
    path: "/tmp/{{ matlab_install }}"
  register: p

- name: Copy the MATLAB install image contents to the host
  copy:
    src: "{{ matlab_install }}"
    dest: "/tmp"
    owner: root
    group: root
    mode: '0755'
  when: "{{ matlab_nfs_src|default(true, true) }} and not p.stat.exists"

- name: Install NFS client
  package: 
    pkg: "{{ matlab_nfs_pkg }}"
    state: present
  when: "{{ matlab_nfs_src|default(false, true) }}"

- name: Add NFS mount for MATLAB install image to /etc/fstab
  mount: 
    path: "/tmp/{{ matlab_install }}"
    src: "{{ matlab_nfs_src }}"
    fstype: nfs 
    opts: "_netdev,nfsvers=3,tcp,rw,hard,intr,timeo=600,retrans=2,noacl"
    dump: "0"
    passno: "2"
    state: present
  when: "{{ matlab_nfs_src|default(false, true) }}"

- name: Mount temporary mount for MATLAB
  command: mount "/tmp/{{ matlab_install }}"
  when: "{{ matlab_nfs_src|default(false, true) }}"

- name: Copy and render the installer input config to the host
  template:
    src: installer_input.txt.j2
    dest: /tmp/installer_input.txt
    owner: root
    group: root
    mode: '0440'

- name: Ensure that directory holding license file exists
  file:
    path: "{{ matlab_installer_options['licensePath'] | dirname }}"
    state: directory

- name: Copy and render the license file on the host
  template:
    src: network.lic.j2
    dest: "{{ matlab_installer_options['licensePath'] }}"
    owner: root
    group: root
    mode: '0440'

# RUN cd /matlab-install \
#    && ./install -mode silent -inputFile /matlab_installer_input.txt
- name: Run the MATLAB installer.
  command: "/tmp/{{ matlab_install }}/install -inputFile /tmp/installer_input.txt"
# I don't think the chdir is actually necessary if you're using a full path.
# I think chaining cd to the install command is a Dockerism.
#    chdir: "/tmp/{{ matlab_install }}"

- name: Add a service account for MATLAB.
  user:
    name: matlab
    home: /var/lib/matlab
    shell: /bin/nologin

- name: Change ownership of the MATLAB directory to the service account.
  file:
    path: "{{ matlab_installer_options['destinationFolder'] }}"
    state: directory
    recurse: yes
    owner: matlab
    group: matlab

- name: Change ownership of the MATLAB license file to the service account.
  file:
    path: "{{ matlab_installer_options['licensePath'] }}"
    state: file
    owner: matlab
    group: matlab

- name: Add symlink from MATLAB binary to /usr/local/bin/matlab
  file:
    src: "{{ matlab_installer_options['destinationFolder'] }}/matlab"
    dest: /usr/local/bin/matlab
    owner: matlab
    group: matlab
    state: link

- name: Remove the contents of the MATLAB install image on disk.
  file:
    path: "/tmp/{{ matlab_install }}"
    state: absent

- name: Remove the installer input config
  file:
    path: /tmp/installer_input.txt
    state: absent

- name: Unmount temporary mount for MATLAB
  command: umount "/tmp/{{ matlab_install }}"
  when: "{{ matlab_nfs_src|default(false, true) }}"

- name: Remove NFS mount for MATLAB install image from /etc/fstab
  mount: 
    path: "/tmp/{{ matlab_install }}"
    src: "{{ matlab_nfs_src }}"
    fstype: nfs 
    opts: "_netdev,nfsvers=3,tcp,rw,hard,intr,timeo=600,retrans=2,noacl"
    dump: "0"
    passno: "2"
    state: absent
  when: "{{ matlab_nfs_src|default(false, true) }}"
